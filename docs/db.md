### 用户表

```sql
DROP TABLE IF EXISTS users;

CREATE TABLE users (
    -- ID主键，使用 PG 的 IDENTITY 特性替代 Auto Increment
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- 核心账号信息
    username        VARCHAR(50) NOT NULL,          -- 昵称
    email           VARCHAR(100) NOT NULL,         -- 核心唯一凭证
    phone           VARCHAR(20),                   -- 手机号

    -- 第三方登录关联 ID (单表设计的核心)
    -- 只有当用户使用对应方式登录时，这些字段才有值，否则为 NULL
    google_id       VARCHAR(100),                  -- Google OpenID / Sub
    x_id            VARCHAR(100),                  -- X (Twitter) ID
    github_id       VARCHAR(100),                  -- Github ID

    -- 用户资料
    avatar_url      VARCHAR(500),
    gender          SMALLINT DEFAULT 0,            -- 0=未知，1=男，2=女
    birthdate       DATE,

    -- 状态与权限
    status          SMALLINT DEFAULT 1,            -- 1=启用，0=禁用
    role            SMALLINT DEFAULT 0,            -- 0=用户，1=管理员
    deleted         SMALLINT DEFAULT 0,            -- 0=正常，1=已删除

    -- 时间字段 (去掉了 ON UPDATE，由代码控制)
    create_time     TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 添加列注释
COMMENT ON COLUMN users.id IS 'ID';
COMMENT ON COLUMN users.username IS '用户名/昵称';
COMMENT ON COLUMN users.email IS '邮箱(唯一凭证)';
COMMENT ON COLUMN users.google_id IS 'Google平台唯一ID';
COMMENT ON COLUMN users.x_id IS 'X/Twitter平台唯一ID';
COMMENT ON COLUMN users.github_id IS 'Github平台唯一ID';
COMMENT ON COLUMN users.status IS '状态：0=禁用，1=启用';
COMMENT ON COLUMN users.deleted IS '逻辑删除：0=正常，1=已删除';

-- === 索引优化 ===

-- 1. 邮箱必须唯一，且查询最频繁
CREATE UNIQUE INDEX idx_users_email ON users(email);

-- 2. 第三方登录 ID 索引
-- 当用户点击 "Google登录" 时，你需要通过 google_id 快速查表
-- 如果查不到，再拿邮箱去查 email 索引
CREATE INDEX idx_users_google_id ON users(google_id);
CREATE INDEX idx_users_x_id ON users(x_id);
CREATE INDEX idx_users_github_id ON users(github_id);

-- 3. 辅助索引 (可选，根据后台管理查询需求决定)
CREATE INDEX idx_users_phone ON users(phone);
```

### 分类表

```sql
DROP TABLE IF EXISTS category;

CREATE TABLE category (
    -- ID主键
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 分类通常不需要BIGINT，INT足够(20亿)

    -- 核心信息
    name VARCHAR(50) NOT NULL, -- 分类名称 (如：科技、生活)
    slug VARCHAR(60), -- SEO友好标识 (如：tech, life)
    icon VARCHAR(500), -- 图标/Icon URL

    -- 层级结构 (支持无限级或二级分类)
    parent_id INT NOT NULL DEFAULT 0, -- 父分D，0表示顶级分类

    -- 排序与统计
    sort INT NOT NULL DEFAULT 0, -- 排序权重 (数值越大越靠前，或越小越靠前，由业务定义)
    circle_count INT NOT NULL DEFAULT 0, -- 该分类下的圈子数量 (缓存字段，用于展示 "科技(102)")

    -- 状态
    status SMALLINT NOT NULL DEFAULT 1, -- 0=禁用/隐藏，1=启用/显示
    deleted SMALLINT DEFAULT 0, -- 逻辑删除

    -- 时间 (用于同步)
    create_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- --- 添加注释 ---
COMMENT ON TABLE category IS '圈子分类表';
COMMENT ON COLUMN category.id IS '分类ID';
COMMENT ON COLUMN category.name IS '分类名称';
COMMENT ON COLUMN category.slug IS 'URL标识符';
COMMENT ON COLUMN category.icon IS '分类图标';
COMMENT ON COLUMN category.parent_id IS '父分类ID(0为顶级)';
COMMENT ON COLUMN category.sort IS '排序权重(人工控制顺序)';
COMMENT ON COLUMN category.circle_count IS '该分类下圈子数(统计缓存)';
COMMENT ON COLUMN category.status IS '状态:0=隐藏,1=显示';
COMMENT ON COLUMN category.deleted IS '逻辑删除';
COMMENT ON COLUMN category.update_time IS '更新时间(用于ES同步)';

-- --- 索引优化 (Index) ---

-- 1. 【必须】唯一性约束
CREATE UNIQUE INDEX idx_category_name ON category(name) WHERE deleted = 0;
CREATE UNIQUE INDEX idx_category_slug ON category(slug) WHERE deleted = 0;

-- 2. 【核心】列表查询索引
-- 场景：APP首页获取全部分类列表，通常按权重排序
-- SQL: SELECT * FROM category WHERE parent_id=0 AND status=1 AND deleted=0 ORDER BY sort DESC
CREATE INDEX idx_category_list ON category(parent_id, sort DESC) WHERE deleted = 0 AND status = 1;

-- 插入顶级分类数据
INSERT INTO category (name, slug, icon, parent_id, sort, circle_count) VALUES
-- 第一梯队：超高热度/刚需
('科技数码', 'tech', NULL, 0, 100, 0),
('游戏电竞', 'gaming', NULL, 0, 95, 0),
('生活日常', 'lifestyle', NULL, 0, 90, 0),
('二次元', 'acg', NULL, 0, 85, 0),
('影音娱乐', 'entertainment', NULL, 0, 80, 0), -- 电影、电视剧、综艺、音乐
('流行文化', 'pop-culture', NULL, 0, 79, 0),

('运动健身', 'sports', NULL, 0, 75, 0),
('美食寻味', 'food', NULL, 0, 70, 0),
('萌宠动物', 'pets', NULL, 0, 65, 0),
('旅行户外', 'travel', NULL, 0, 60, 0), -- 露营、旅游
('汽车出行', 'cars', NULL, 0, 55, 0), -- 汽车、摩托车

('财经投资', 'finance', NULL, 0, 50, 0), -- 股票、基金、理财
('职场发展', 'career', NULL, 0, 45, 0),
('知识科普', 'knowledge', NULL, 0, 40, 0), -- 硬核知识、百科
('校园教育', 'education', NULL, 0, 38, 0), -- 升学、考研、校园生活

('阅读文学', 'reading', NULL, 0, 35, 0), -- 书籍、网文
('摄影摄像', 'photography', NULL, 0, 30, 0),
('时尚美妆', 'fashion', NULL, 0, 25, 0),
('艺术设计', 'art', NULL, 0, 20, 0), -- 绘画、设计
('家居房产', 'home', NULL, 0, 15, 0), -- 装修、租房

('亲子育儿', 'parenting', NULL, 0, 10, 0),
('情感心理', 'emotion', NULL, 0, 5, 0),
('新闻政治', 'history-politic', NULL, 0, 4, 0),
('历史人文', 'history-humannity', NULL, 0, 3, 0),
('其它兴趣', 'others', NULL, 0, 2, 0),
('小众猎奇', 'niche-exotic', NULL, 0, 1, 0)
```

### 兴趣圈表

```sql
DROP TABLE IF EXISTS circle;

CREATE TABLE circle (
    -- ID主键，使用 PG 的 IDENTITY 特性替代 Auto Increment
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    name VARCHAR(50) NOT NULL, -- 兴趣圈名称
    slug VARCHAR(60), -- 唯一标识符(用于URL SEO，如 /circle/coding-life)，允许为空
    avatar_url VARCHAR(500), -- 兴趣圈头像url
    cover_url VARCHAR(500), -- 背景图url
    description TEXT NOT NULL, -- 描述信息
    rule TEXT NOT NULL, -- 圈内规则

    -- 3. 归属与分类
    creator_id BIGINT NOT NULL, -- 创建人ID (关联用户表)
    category_id INT NOT NULL DEFAULT 0, -- 分类ID (关联分类表)

    -- 4. 统计数据 (反范式设计，避免频繁 Count 查询)
    hot INT NOT NULL DEFAULT 0, -- 热度值 (计算所得)
    member_count INT NOT NULL DEFAULT 0, -- 成员数量
    post_count INT NOT NULL DEFAULT 0, -- 帖子数量

    -- 5. 状态与权限
    join_type SMALLINT NOT NULL DEFAULT 0, -- 加入方式：0=直接加入，1=需审核，2=私密(邀请制)
    status SMALLINT NOT NULL DEFAULT 1, -- 状态：0=审核中，1=正常，2=被封禁/冻结

    deleted SMALLINT DEFAULT 0, -- 0=正常，1=已删除

    -- 时间字段 (去掉了 ON UPDATE，由代码控制)
    create_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);


-- --- 添加注释 (PostgreSQL 标准写法) ---
COMMENT ON TABLE circle IS '兴趣圈/社区表';
COMMENT ON COLUMN circle.id IS '主键ID';
COMMENT ON COLUMN circle.name IS '圈子名称';
COMMENT ON COLUMN circle.slug IS 'URL友好的唯一标识符';
COMMENT ON COLUMN circle.avatar_url IS '圈子头像URL';
COMMENT ON COLUMN circle.cover_url IS '圈子封面背景图URL';
COMMENT ON COLUMN circle.description IS '圈子描述';
COMMENT ON COLUMN circle.rule IS '圈子规则';
COMMENT ON COLUMN circle.creator_id IS '创建者用户ID';
COMMENT ON COLUMN circle.category_id IS '所属分类ID';
COMMENT ON COLUMN circle.hot IS '综合热度值';
COMMENT ON COLUMN circle.member_count IS '成员总数(缓存字段)';
COMMENT ON COLUMN circle.post_count IS '帖子总数(缓存字段)';
COMMENT ON COLUMN circle.join_type IS '加入限制：0=公开，1=审核，2=私密';
COMMENT ON COLUMN circle.status IS '圈子状态：0=待审，1=正常，2=封禁';
COMMENT ON COLUMN circle.deleted IS '逻辑删除：0=未删，1=已删';
COMMENT ON COLUMN circle.create_time IS '创建时间';
COMMENT ON COLUMN circle.update_time IS '更新时间';

-- --- 创建索引 (Index) ---

-- 1. 唯一性约束
-- 圈子名称不允许重复，且只检测未删除的记录
CREATE UNIQUE INDEX idx_circle_name ON circle(name) WHERE deleted = 0;
-- 如果使用了 slug 用于 URL 访问
CREATE UNIQUE INDEX idx_circle_slug ON circle(slug) WHERE deleted = 0;
```

### 权限表

```sql
DROP TABLE IF EXISTS circle_member;

CREATE TABLE circle_member (
    -- ID主键
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- 核心关系
    circle_id BIGINT NOT NULL, -- 圈子ID
    user_id BIGINT NOT NULL, -- 用户ID

    -- 角色与权限 (RBAC核心)
    -- 10=普通成员, 20=管理员, 30=圈主 (使用间隔数字，方便未来插入"副圈主"或"嘉宾")
    role SMALLINT NOT NULL DEFAULT 10,

    -- 成员状态 (控制访问权)
    -- 0=待审核(申请中), 1=正常, 2=禁言(Muted), 3=拉黑/踢出(Banned)
    status SMALLINT NOT NULL DEFAULT 1,

    -- 禁言控制 (结合 status=2 使用)
    mute_end_time TIMESTAMPTZ, -- 禁言结束时间，NULL或过去时间代表无禁言

    -- 个性化设置 (用户对该圈子的设置)
    is_top SMALLINT DEFAULT 0, -- 是否置顶显示 (0=否, 1=是)
    is_disturb SMALLINT DEFAULT 0, -- 消息免打扰 (0=否, 1=是)

    -- 时间字段
    create_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 加入时间
    update_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP  -- 角色/状态变更时间
);

-- --- 注释 ---
COMMENT ON TABLE circle_member IS '圈子成员关系与权限表';
COMMENT ON COLUMN circle_member.role IS '角色: 10=成员, 20=管理员, 30=圈主';
COMMENT ON COLUMN circle_member.status IS '状态: 0=申请中, 1=正常, 2=禁言, 3=拉黑';
COMMENT ON COLUMN circle_member.mute_end_time IS '禁言截止时间';

-- --- 索引优化---

-- 1. 【必须】唯一性约束 (防止重复加入)
-- 每个用户在同一个圈子只能有一条记录
CREATE UNIQUE INDEX idx_member_unique ON circle_member(circle_id, user_id);

-- 2. 【核心】查询 "我加入的圈子"
-- 场景：APP "我的" 页面，或校验用户发帖权限
-- 包含 role 和 status 是为了覆盖索引(Covering Index)，查权限时不回表
CREATE INDEX idx_member_user ON circle_member(user_id, role, status);

-- 3. 【管理】查询 "圈子的管理员列表" 或 "圈子成员列表"
-- 场景：圈主管理成员，或者展示成员列表
CREATE INDEX idx_member_circle_role ON circle_member(circle_id, role DESC, create_time DESC);
```

### 帖子表

```sql
DROP TABLE IF EXISTS post;

CREATE TABLE post (
    -- ID主键
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- 1. 归属关系 (核心外键)
    circle_id BIGINT NOT NULL,          -- 所属圈子ID
    user_id BIGINT NOT NULL,            -- 发帖人ID

    -- 2. 内容主体
    type SMALLINT NOT NULL DEFAULT 1,   -- 帖子类型：1=图文, 2=纯视频, 3=投票/链接
    title VARCHAR(200) NOT NULL DEFAULT '', -- 标题 (允许为空，适配微博/朋友圈式的短内容)
    summary VARCHAR(500) NOT NULL DEFAULT '', -- 摘要 (纯文本，用于推送/列表预览，去除了HTML标签)
    content TEXT NOT NULL DEFAULT '',   -- 正文 (富文本/Mardown/HTML)

    -- 3. 多媒体与扩展
    -- 存储图片URL列表、视频封面/地址、链接卡片信息等
    -- 结构示例: { "images": ["url1", "url2"], "video": {"url": "...", "cover": "..."}, "vote_id": 123 }
    media_extra JSONB NOT NULL DEFAULT '{}'::JSONB,

    -- 4. 统计数据
    view_count INT NOT NULL DEFAULT 0,    -- 浏览量
    comment_count INT NOT NULL DEFAULT 0, -- 评论数
    like_count INT NOT NULL DEFAULT 0,    -- 点赞数
    collect_count INT NOT NULL DEFAULT 0, -- 收藏数

    -- 5. 运营与状态标记
    is_pinned SMALLINT NOT NULL DEFAULT 0,  -- 是否置顶：0=否, 1=是 (圈内置顶)
    is_essence SMALLINT NOT NULL DEFAULT 0, -- 是否加精：0=否, 1=是
    is_lock SMALLINT NOT NULL DEFAULT 0,    -- 是否锁定：0=否, 1=是 (禁止评论)

    -- 6. 审核与生命周期
    -- 状态：0=草稿, 1=发布(正常), 2=审核中(若开启先审后发), 3=审核失败, 4=被屏蔽(软删/违规)
    status SMALLINT NOT NULL DEFAULT 1,
    deleted SMALLINT DEFAULT 0, -- 用户自行删除：0=未删, 1=已删

    -- 7. 时间字段
    create_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_reply_time TIMESTAMPTZ -- 最后回复时间 (用于"按最新回复排序"的传统论坛模式，可选)
);

-- --- 注释 ---
COMMENT ON TABLE post IS '帖子主表';
COMMENT ON COLUMN post.circle_id IS '所属圈子ID';
COMMENT ON COLUMN post.user_id IS '作者用户ID';
COMMENT ON COLUMN post.type IS '类型:1=图文,2=视频,3=投票';
COMMENT ON COLUMN post.title IS '标题';
COMMENT ON COLUMN post.summary IS '纯文本摘要';
COMMENT ON COLUMN post.content IS '正文内容(Text)';
COMMENT ON COLUMN post.media_extra IS '媒体扩展信息(JSONB存储图片/视频)';
COMMENT ON COLUMN post.view_count IS '浏览数';
COMMENT ON COLUMN post.is_pinned IS '是否置顶';
COMMENT ON COLUMN post.is_essence IS '是否加精';
COMMENT ON COLUMN post.status IS '状态:1=正常,2=审核中,3=驳回,4=屏蔽';
COMMENT ON COLUMN post.update_time IS '更新时间(ES同步锚点)';

-- --- 索引优化 ---

-- 1. 【核心】外键关联索引
-- 场景：用户进入圈子详情页，PG 校验圈子是否存在
CREATE INDEX idx_post_circle ON post(circle_id);

-- 2. 【用户】"我的帖子" 列表
-- 场景：用户中心查看发布历史。这个通常直接走数据库，因为不仅要看正常的，还要看草稿/审核中的
CREATE INDEX idx_post_user ON post(user_id, status, create_time DESC);

-- 3. 【管理】后台审核/管理索引
-- 场景：后台管理系统按状态筛选帖子进行人工审核
CREATE INDEX idx_post_status ON post(status, create_time DESC);

-- 4. 【置顶】获取圈子置顶帖
-- 场景：置顶帖数量很少(3-5条)，通常不走ES，直接查DB置顶然后插在列表最前面
CREATE INDEX idx_post_pinned ON post(circle_id) WHERE is_pinned = 1 AND deleted = 0;
```

### 评论索引表

```sql
CREATE TABLE comment_index (
    -- ID主键
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- 1. 归属关系
    post_id BIGINT NOT NULL,            -- 所属帖子ID
    user_id BIGINT NOT NULL,            -- 发布者ID

    -- 2. 结构关系 (二级扁平化)
    root_id BIGINT NOT NULL DEFAULT 0,      -- 根评论ID (0=顶层)
    reply_to_id BIGINT NOT NULL DEFAULT 0,  -- 被回复ID

    -- 3. 统计数据 (高频更新字段)
    like_count INT NOT NULL DEFAULT 0,      -- 点赞数
    reply_count INT NOT NULL DEFAULT 0,     -- 子评论数

    -- 4. 状态与时间
    status SMALLINT NOT NULL DEFAULT 1,     -- 1=正常, 2=审核中, 3=隐藏
    deleted SMALLINT DEFAULT 0,             -- 0=正常, 1=已删除
    create_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 2. 添加表注释
COMMENT ON TABLE comment_index IS '评论索引/元数据表：存储评论的轻量级元数据，用于列表检索、排序和统计，不包含大文本内容';

-- 3. 添加列注释
COMMENT ON COLUMN comment_index.id IS '主键ID';
COMMENT ON COLUMN comment_index.post_id IS '所属帖子ID (关联业务方ID)';
COMMENT ON COLUMN comment_index.user_id IS '评论发布者ID';
COMMENT ON COLUMN comment_index.root_id IS '根评论ID：0表示这是一条顶层评论(楼主)，否则存放所属的顶层评论ID';
COMMENT ON COLUMN comment_index.reply_to_id IS '被回复的评论ID：0表示非回复特定人，否则存放被回复的那条评论ID';
COMMENT ON COLUMN comment_index.like_count IS '点赞数：高频更新字段，建议配合 Redis Write-Behind 策略';
COMMENT ON COLUMN comment_index.reply_count IS '子回复数：该评论下的回复数量';
COMMENT ON COLUMN comment_index.status IS '状态：1=正常, 2=审核中, 3=审核不通过/折叠';
COMMENT ON COLUMN comment_index.deleted IS '逻辑删除：0=正常, 1=已删除 (仅在索引表标记即可)';
COMMENT ON COLUMN comment_index.create_time IS '创建时间';
COMMENT ON COLUMN comment_index.update_time IS '元数据更新时间 (如点赞、状态变更时更新)';

-- 核心索引设计 (根据查询模式优化）
-- 场景：查询某个帖子下的顶层评论，按点赞数量倒序
CREATE INDEX idx_comment_post_root_like ON comment_index (post_id, root_id, like_count DESC);
-- 场景：查询某个帖子下的顶层评论，按时间倒序
CREATE INDEX idx_comment_post_root_time ON comment_index (post_id, root_id, create_time DESC);

-- 场景：查询用户的历史评论
CREATE INDEX idx_comment_user_time ON comment_index (user_id, create_time DESC);

-- 场景：查询某个根评论下的所有子回复
CREATE INDEX idx_comment_root_id ON comment_index (root_id) WHERE root_id > 0;
```

### 评论详情表

```sql
CREATE TABLE comment_content (
    -- 主键即评论ID (1:1 关系)
    comment_id BIGINT PRIMARY KEY,

    -- 内容 (大字段)
    content TEXT NOT NULL,

    -- 扩展：富文本结构/图片/视频JSON (预留)
    extra_data JSONB DEFAULT '{}'::JSONB,

    -- 0=正常, 1=已删除
    deleted SMALLINT DEFAULT 0
);

-- 2. 添加表注释
COMMENT ON TABLE comment_content IS '评论内容表：存储评论的大文本内容，通过主键与索引表1:1关联，实现冷热分离';

-- 3. 添加列注释
COMMENT ON COLUMN comment_content.comment_id IS '评论ID：与 comment_index.id 一一对应，不使用自增';
COMMENT ON COLUMN comment_content.content IS '评论文本内容：使用 TEXT 类型，不限制长度';
COMMENT ON COLUMN comment_content.extra_data IS '扩展数据：JSON格式，用于存储富文本结构、图片列表、视频链接等附加信息';
```

### 评论点赞表

```sql
-- 评论点赞表 (comment_like)
DROP TABLE IF EXISTS comment_like;

CREATE TABLE comment_like (
    -- ID主键
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- 核心关系
    user_id BIGINT NOT NULL,           -- 点赞人
    comment_id BIGINT NOT NULL,         -- 被点赞的评论

    -- 冗余字段 (可选，但推荐)
    post_id BIGINT NOT NULL DEFAULT 0,  -- 冗余帖子ID，有助于查询

    -- 点赞状态 (0=有效点赞, 1=取消点赞)
    deleted SMALLINT NOT NULL DEFAULT 0,

    create_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- --- 注释 ---
COMMENT ON TABLE comment_like IS '评论点赞流水表';
COMMENT ON COLUMN comment_like.deleted IS '点赞状态: 0=有效点赞, 1=取消点赞';
COMMENT ON COLUMN comment_like.post_id IS '冗余帖子ID，便于查询';

-- --- 索引优化 ---

-- 1. 【核心】保证每个用户对每个评论只有一条点赞/取消点赞的记录
CREATE UNIQUE INDEX uk_comment_like_user_comment ON comment_like(user_id, comment_id);

-- 2. 【核心】查询"我点赞过的评论"
-- 当用户在个人中心查看"我赞过的评论"时使用。
CREATE INDEX idx_clike_user_active ON comment_like(user_id, create_time DESC) WHERE deleted = 0;

-- 3. 【统计/关联】查询某评论的点赞者列表 (通常只显示头像，不常翻页)
-- 配合 `deleted=0` 查询有效点赞者。
CREATE INDEX idx_clike_comment_active ON comment_like(comment_id, create_time DESC) WHERE deleted = 0;
```

### 帖子点赞表

```sql
-- 帖子点赞表 (post_like)
DROP TABLE IF EXISTS post_like;

CREATE TABLE post_like (
    -- ID主键
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- 核心关系
    user_id BIGINT NOT NULL,           -- 点赞人
    post_id BIGINT NOT NULL DEFAULT 0,  -- 帖子ID

    -- 点赞状态 (0=有效点赞, 1=取消点赞)
    deleted SMALLINT NOT NULL DEFAULT 0,

    create_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- --- 注释 ---
COMMENT ON TABLE post_like IS '帖子点赞流水表';
COMMENT ON COLUMN post_like.deleted IS '点赞状态: 0=有效点赞, 1=取消点赞';
COMMENT ON COLUMN post_like.post_id IS '帖子ID，便于查询';

-- --- 索引优化---

-- 1. 【核心】保证每个用户对每个评论只有一条点赞/取消点赞的记录
CREATE UNIQUE INDEX uk_post_like_user_comment ON post_like(user_id, post_id);

-- 2. 【核心】查询"我点赞过的帖子"
-- 当用户在个人中心查看"我赞过的帖子"时使用。
CREATE INDEX idx_user_post_active ON post_like(user_id, create_time DESC) WHERE deleted = 0;

-- 3. 【统计/关联】查询某贴子的点赞者列表
-- 配合 `deleted=0` 查询有效点赞者。
CREATE INDEX idx_clike_post_active ON post_like(post_id, create_time DESC) WHERE deleted = 0;
```
